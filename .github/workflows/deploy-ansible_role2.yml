name: Deploy Flask App to EC2 via Ansible

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches:
      - main           # Trigger on push to main

jobs:
  deploy:
    name: Provision and Deploy EC2
    runs-on: ubuntu-latest

    env:
      ANSIBLE_HOST_KEY_CHECKING: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Ansible and AWS collection
      run: |
        python -m pip install --upgrade pip
        pip install ansible boto3 botocore
        ansible-galaxy collection install amazon.aws

    - name: Add SSH key for EC2 access
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/flask-deploy-key.pem
        chmod 600 ~/.ssh/flask-deploy-key.pem

    - name: Run Ansible Playbook
      run: |
        ansible-playbook ec2.yml \
          -e "app_url=${{ secrets.APP_ZIP_URL }}" \
          -e "app_dir=/home/ubuntu/flask-app"
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
