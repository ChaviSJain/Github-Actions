name: Deploy Flask App via Ansible

on:
    workflow_dispatch:

jobs:
    ansible-deploy:
        runs-on: ubuntu-latest

        env:
            ANSIBLE_HOST_KEY_CHECKING: "False"
            PRIVATE_KEY: ${{ secrets.SHH_PRIVATE_KEY }}
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}     # AWS creds from GitHub Secrets
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_DEFAULT_REGION: ap-south-1                          # Change to your region

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: 🛠️ Install Ansible & AWS CLI
              run: |
                sudo apt update
                sudo apt install -y ansible awscli   # Install both Ansible and AWS CLI

            - name: 🔍 Get EC2 Public IP dynamically
              id: ec2ip
              run: |
                EC2_IP=$(aws ec2 describe-instances \
                  --filters "Name=tag:Name,Values=flask-server" "Name=instance-state-name,Values=running" \
                  --query "Reservations[0].Instances[0].PublicIpAddress" \
                  --output text)
                echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV
                echo "Public IP: $EC2_IP"

            - name: 🔐 Setup SSH key
              run: |
                mkdir -p ~/.ssh
                echo "$PRIVATE_KEY" > ~/.ssh/id_rsa
                chmod 600 ~/.ssh/id_rsa
                ssh-keyscan -H $EC2_IP >> ~/.ssh/known_hosts   # Use dynamic IP

            - name: Run Ansible Playbook
              run: |
                  ansible-playbook -i "$EC2_IP," -u ubuntu --private-key ~/.ssh/id_rsa play-deploy-test-app.yml
                  # "$EC2_IP," : Use dynamic IP inline inventory (comma required!)
                  # -u ubuntu : Default Ubuntu user for EC2
                  # --private-key : Use the SSH key we set up
